/*
 * This source file was generated by the Gradle 'init' task
 */
package org.example

import app.cash.sqldelight.driver.jdbc.asJdbcDriver
import com.zaxxer.hikari.HikariConfig
import com.zaxxer.hikari.HikariDataSource
import org.example.api.api
import org.example.repository.CatsRepository
import org.example.service.CatService
import org.http4k.server.Jetty
import org.http4k.server.asServer
import java.time.Clock

fun main() {

    // Set below values, either in run configuration or using terminal
    val dbConfig = HikariConfig().apply {
        jdbcUrl = System.getenv("JDBC_DATABASE_URL")!!
        username = System.getenv("JDBC_DATABASE_USERNAME")!!
        password = System.getenv("JDBC_DATABASE_PASSWORD")!!
    }

    val datasource = HikariDataSource(dbConfig)
        .asJdbcDriver()
        .also { Database.Schema.create(it) }
        .let { Database(it) }

    CatService(
        CatsRepository(datasource.catsQueries),
        Clock.systemUTC())
        .api()
        .asServer(Jetty(8080)) // you can use Jetty or JettyLoom which uses virtual threads
        // .asServer(SunHttp(0)) - by default http4k comes with SunHttpServer, which should not be used in production
        // if you want to use a different server, use one from this list: https://www.http4k.org/ecosystem/http4k/reference/servers/
        .start()
}
